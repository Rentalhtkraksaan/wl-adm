
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard CWU Gen 2 - Input Terintegrasi & Hasil Akhir Ringkas</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <style>
        /* CSS Dasar tetap sama, hanya menambahkan style untuk tombol Aksi */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #008CBA;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            padding: 30px;
            max-width: 1400px;
            margin: 20px auto;
        }
        .form-section, .table-section {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 350px;
            margin-bottom: 30px;
        }
        .input-group-row {
            display: flex;
            gap: 20px;
        }
        .input-group-row > .form-group {
            flex: 1;
        }
        .table-section {
            flex-basis: 100%; 
            min-width: 100%;
            overflow-x: auto; 
        }
        h2 {
            color: #008CBA;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        hr.dashed { border: 0; border-top: 1px dashed #ccc; margin: 15px 0; }
        .form-group { margin-bottom: 15px; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1em;
            transition: border-color 0.3s; /* Tambahkan transisi untuk border */
        }
        
        /* Aksi dan Tombol */
        button {
            background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; margin-top: 10px; width: 100%;
            transition: background-color 0.3s;
        }
        #addItemBtn { background-color: #28a745; }
        .remove-item-btn { background-color: #dc3545; width: auto; }
        .action-btn { 
            padding: 5px 10px; 
            margin: 2px 0;
            width: auto;
            font-size: 0.8em;
            display: block; 
        }
        .edit-btn { background-color: orange; }
        .delete-btn { background-color: #dc3545; }
        .filter-btn {
            background-color: #007bff; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; margin-right: 5px; width: auto; font-size: 0.9em; margin-top: 0;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px 8px; text-align: left; font-size: 0.85em; }
        th { background-color: #e3f2fd; color: #333; font-weight: 700; }
        .item-list-cell { white-space: pre-wrap; max-width: 200px; }
        #jabatanGroup { display: none; background-color: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        
        /* Fitur Pencarian */
        .search-container { margin-bottom: 15px; }
        #searchInput { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        /* Status Color */
        .red-status-table { color: #dc3545; font-weight: bold; }
        
        /* Pewarnaan Merah/Hijau di Kolom Tertentu (BARU/Diperbarui) */
        .cell-red-bg { background-color: #ffdddd; } /* Merah muda */
        .cell-green-bg { background-color: #ddffdd; } /* Hijau muda */
        .status-indicator { display: block; font-size: 0.9em; margin-top: 5px; font-weight: bold; }

    </style>
</head>
<body>

    <header>
        <h1>Dashboard CWU Gen 2</h1>
    </header>

    <div class="container">
        <section class="form-section" id="integrated-form">
            <h2>üìù Input Data Anggota & Pesanan (Satu Langkah)</h2>
            
            <form id="integratedForm">
                <input type="hidden" id="editKeyAnggota" value="">
                <input type="hidden" id="editKeyPesanan" value="">

                
                <h3>1. Data Anggota (Wajib diisi)</h3>
                <hr class="dashed">
                <div class="form-group"><label for="nama">Nama:</label><input type="text" id="nama" required></div>
                
                <div class="input-group-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="divisi">Divisi:</label>
                        <select id="divisi" required onchange="updateDivisiFields()">
                            <option value="">Pilih Divisi</option>
                            <option value="Bpi">Bpi</option>
                            <option value="Medinfo">Medinfo</option>
                            <option value="Network">Network</option>
                            <option value="Kwu">Kwu</option>
                            <option value="Demis">Demis</option>
                            <option value="Inbis">Inbis</option> 
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Kuota Divisi (<span id="currentCount">0</span>/<span id="maxQuota">0</span>):</label>
                        <span id="kuotaDisplay" style="font-weight: bold; display: block; font-size: 1.2em;">-</span>
                    </div>
                </div>

                <div id="jabatanGroup">
                    <div class="form-group">
                        <label for="jabatanBPI">Jabatan BPI:</label>
                        <select id="jabatanBPI">
                            <option value="">Pilih Jabatan</option>
                            <option value="Ketua">Ketua</option>
                            <option value="Wakil">Wakil</option>
                            <option value="Sekretaris 1">Sekretaris 1</option>
                            <option value="Sekretaris 2">Sekretaris 2</option>
                            <option value="Bendahara 1">Bendahara 1</option>
                            <option value="Bendahara 2">Bendahara 2</option>
                        </select>
                    </div>
                </div>

                <div class="input-group-row">
                    <div class="form-group">
                        <label for="prodi">Program Studi (Prodi):</label>
                        <input type="text" id="prodi" required placeholder="Contoh: Informatika">
                    </div>
                    <div class="form-group" style="flex: 0.5;">
                        <label for="angkatan">Angkatan:</label>
                        <select id="angkatan" required>
                            <option value="">Pilih Tahun</option>
                            <option value="2021">2021</option>
                            <option value="2022">2022</option>
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                </div>

                <div class="input-group-row">
                    <div class="form-group">
                        <label for="welpart">Kontribusi Welpart (Rp):</label>
                        <input type="number" id="welpart" required min="0" oninput="checkWelpart()">
                        <span id="welpartStatus" class="status-indicator"></span>
                    </div>
                    <div class="form-group" id="kasGroup">
                        <label for="kas">Kontribusi Kas (Rp):</label>
                        <input type="number" id="kas" required min="0" oninput="checkKas()">
                        <span id="kasStatus" class="status-indicator"></span>
                    </div>
                </div>
                
                <h3 style="margin-top: 30px;">2. Detail Pesanan (Minimal 1 Item)</h3>
                <hr class="dashed">
                
                <div id="item-list">
                    <div class="item-group" id="item_1">
                        <h4>Item 1</h4>
                        <div class="input-group-row">
                            <div class="form-group"><label>Makanan:</label><input type="text" class="nama-makan" required></div>
                            <div class="form-group"><label>Minuman:</label><input type="text" class="nama-minum" required></div>
                            <div class="form-group" style="flex: 0.5;"><label>Harga (Rp):</label><input type="number" class="harga-item" required min="0" oninput="calculateTotal()"></div>
                        </div>
                    </div>
                </div>

                <button type="button" id="addItemBtn">‚ûï Tambah Item Pesanan</button>

                <div class="input-group-row" style="margin-top: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="tagihanAkhir">Tagihan Total Pesanan:</label>
                        <input type="text" id="tagihanAkhir" readonly style="font-weight: bold; background-color: #eee;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="hasilAkhirInput">Hasil Akhir (Rp):</label>
                        <input type="number" id="hasilAkhirInput" required placeholder="Input Hasil Akhir Manual">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label for="status">Status Pembayaran:</label>
                    <select id="status" required>
                        <option value="lunas">Lunas</option>
                        <option value="tidak">Tidak Lunas</option>
                    </select>
                </div>

                <button type="submit" id="submitBtn" style="background-color: #4CAF50;">üíæ Simpan Anggota & Pesanan (Selesai)</button>
            </form>
        </section>
    </div>
    
    <div class="container">
        <section class="table-section">
            <h2>üìä Laporan Gabungan Hasil Akhir</h2>
            
            <div class="search-container">
                <label for="searchInput">Cari Data (Nama, Divisi, Prodi):</label>
                <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Ketik untuk mencari...">
            </div>

            <div class="filter-container" style="margin-bottom: 15px;">
                <label style="font-weight: bold; margin-right: 10px;">Filter Divisi:</label>
                <button class="filter-btn" data-divisi="" style="background-color: #28a745; color: white;">Semua</button>
                <button class="filter-btn" data-divisi="Bpi" style="background-color: #007bff;">Bpi</button>
                <button class="filter-btn" data-divisi="Medinfo" style="background-color: #007bff;">Medinfo</button>
                <button class="filter-btn" data-divisi="Kwu" style="background-color: #007bff;">Kwu</button>
                <button class="filter-btn" data-divisi="Network" style="background-color: #007bff;">Network</button>
                <button class="filter-btn" data-divisi="Demis" style="background-color: #007bff;">Demis</button>
                <button class="filter-btn" data-divisi="Inbis" style="background-color: #007bff;">Inbis</button>
            </div>

            <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                <button id="deleteSelectedBtn" style="background-color: #dc3545; width: auto; display: none; margin-top: 0;">üóëÔ∏è Hapus yang Dipilih (<span id="selectedCount">0</span>)</button>
                <button id="undoDeleteBtn" style="background-color: #ffc107; width: auto; display: none; margin-top: 0; color: #333;">‚Ü©Ô∏è Undo Hapus</button>
            </div>


            <table id="finalDataTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllCheckbox"></th> 
                        <th>No.</th>
                        <th>Nama</th>
                        <th>Div</th>
                        <th>Prodi-Akt</th>
                        <th>Pesanan</th>
                        <th>Total Pesanan</th>
                        <th>Welpart</th>
                        <th>Kas</th>
                        <th>Hasil Akhir</th> 
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="12" style="text-align: center;">Memuat data gabungan...</td></tr>
                </tbody>
            </table>
        </section>
    </div>

<script>
    // --- 1. KONFIGURASI FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDpPEkKbEt6b_v2OWlBfGuaVQpBg2-RWR4",
        authDomain: "cwu-gen-2.firebaseapp.com",
        databaseURL: "https://cwu-gen-2-default-rtdb.firebaseio.com",
        projectId: "cwu-gen-2",
        storageBucket: "cwu-gen-2.appspot.com",
        messagingSenderId: "40585612014",
        appId: "1:40585612014:web:c88141fee3699aca68181ff",
        measurementId: "G-S8D7DFJ1G3"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // --- 2. VARIABEL & DOM ELEMENTS ---
    // PENAMBAHAN DIVISI INBIS (Kuota 12)
    const kuotaDivisi = { Bpi: 6, Medinfo: 10, Network: 14, Kwu: 12, Demis: 10, Inbis: 12 }; 
    // STANDAR MINIMUM WELPART & KAS (Disarankan)
    const minWelpart = 7000; // Contoh: Minimum Welpart 20.000
    const minKas = 10000; // Contoh: Minimum Kas 10.000

    let currentDivisiCounts = {}; 
    const formatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 });

    const finalTableBody = document.querySelector('#finalDataTable tbody');
    const integratedForm = document.getElementById('integratedForm');
    const submitBtn = document.getElementById('submitBtn');
    const divisiSelect = document.getElementById('divisi');
    const welpartInput = document.getElementById('welpart');
    const kasInput = document.getElementById('kas');
    const editKeyAnggotaInput = document.getElementById('editKeyAnggota');
    const editKeyPesananInput = document.getElementById('editKeyPesanan');
    const hasilAkhirInput = document.getElementById('hasilAkhirInput'); 
    const filterButtons = document.querySelectorAll('.filter-btn');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const undoDeleteBtn = document.getElementById('undoDeleteBtn');
    const selectedCountSpan = document.getElementById('selectedCount');
    const welpartStatusSpan = document.getElementById('welpartStatus');
    const kasStatusSpan = document.getElementById('kasStatus');

    let itemCounter = 1;
    let combinedData = []; 
    let currentFilterDivisi = '';
    let deletedItemsCache = []; // Untuk fungsi Undo

    // --- 3. FUNGSI UTAMA (LOGIKA BARU) ---

    // FUNGSI BARU: Cek Status Welpart (Merah/Hijau)
    function checkWelpart() {
        const val = parseInt(welpartInput.value) || 0;
        const isSesuai = val >= minWelpart;

        welpartStatusSpan.textContent = isSesuai 
            ? '‚úÖ Sudah Sesuai' 
            : `‚ùå Kurang dari ${formatter.format(minWelpart)}`;
        welpartStatusSpan.style.color = isSesuai ? 'green' : 'red';
        welpartInput.style.borderColor = isSesuai ? 'green' : 'red';
    }

    // FUNGSI BARU: Cek Status Kas (Merah/Hijau)
    function checkKas() {
        const val = parseInt(kasInput.value) || 0;
        const isSesuai = val >= minKas;

        kasStatusSpan.textContent = isSesuai 
            ? '‚úÖ Sudah Sesuai' 
            : `‚ùå Kurang dari ${formatter.format(minKas)}`;
        kasStatusSpan.style.color = isSesuai ? 'green' : 'red';
        kasInput.style.borderColor = isSesuai ? 'green' : 'red';
    }

    welpartInput.oninput = checkWelpart;
    kasInput.oninput = checkKas;

    // FUNGSI BARU: Memperbarui Kuota Divisi dan Blokir Pilihan yang Penuh
    function updateDivisiFields(isEditMode = false, currentDivisi = null) {
        const selectedDivisi = divisiSelect.value;
        const currentCount = currentDivisiCounts[selectedDivisi] || 0;
        const maxQuota = kuotaDivisi[selectedDivisi] || 0;

        document.getElementById('currentCount').textContent = currentCount;
        document.getElementById('maxQuota').textContent = maxQuota;
        document.getElementById('kuotaDisplay').textContent = selectedDivisi ? `${currentCount}/${maxQuota}` : '-';

        // Tampilkan/Sembunyikan Jabatan BPI
        document.getElementById('jabatanGroup').style.display = selectedDivisi === 'Bpi' ? 'block' : 'none';

        // LOGIKA BLOKIR DIVISI
        divisiSelect.querySelectorAll('option').forEach(option => {
            const div = option.value;
            if (div && kuotaDivisi[div]) {
                const count = currentDivisiCounts[div] || 0;
                const quota = kuotaDivisi[div];
                // Jika sedang mode edit, jangan blokir divisi yang sedang diedit (anggota tsb)
                const isCurrentEditDivisi = isEditMode && div === currentDivisi; 
                const isFull = count >= quota && !isCurrentEditDivisi;
                
                option.disabled = isFull;
                option.textContent = isFull ? `${div} (PENUH: ${quota})` : div;
            }
        });
    }

    divisiSelect.addEventListener('change', () => updateDivisiFields());


    // Fungsi Generik untuk Simpan/Update
    async function saveOrUpdateToFirebase(path, key, data, formName) {
        try {
            if (key) {
                await database.ref(`${path}/${key}`).set(data);
                return `‚úÖ Data ${formName} berhasil **diperbarui**.`;
            } else {
                const newRef = database.ref(path).push(data);
                return newRef.key;
            }
        } catch (error) {
            console.error('Firebase Save/Update Error:', error);
            throw new Error(`‚ùå Gagal menyimpan/memperbarui data ${formName}.`);
        }
    }
    
    /**
     * FUNGSI: Mengembalikan formulir ke keadaan semula (Pulih/Bersih)
     */
    function resetIntegratedForm() {
        integratedForm.reset();
        editKeyAnggotaInput.value = '';
        editKeyPesananInput.value = '';
        submitBtn.textContent = 'üíæ Simpan Anggota & Pesanan (Selesai)';
        
        // Reset Item List ke Item 1 Kosong
        itemCounter = 1;
        document.getElementById('item-list').innerHTML = `
            <div class="item-group" id="item_1">
                <h4>Item 1</h4>
                <div class="input-group-row">
                    <div class="form-group"><label>Makanan:</label><input type="text" class="nama-makan" required></div>
                    <div class="form-group"><label>Minuman:</label><input type="text" class="nama-minum" required></div>
                    <div class="form-group" style="flex: 0.5;"><label>Harga (Rp):</label><input type="number" class="harga-item" required min="0" oninput="calculateTotal()"></div>
                </div>
            </div>
        `;
        calculateTotal();
        // Reset status dan border warna
        welpartInput.style.borderColor = '#ddd'; 
        kasInput.style.borderColor = '#ddd'; 
        welpartStatusSpan.textContent = '';
        kasStatusSpan.textContent = '';
        updateDivisiFields(); 
    }

    // FUNGSI INTI: Handle Submit Form Terintegrasi (Simpan/Edit)
    integratedForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const isEditMode = !!editKeyAnggotaInput.value;
        const selectedDivisi = divisiSelect.value;
        
        // Cek Kuota (Hanya mode Tambah Baru)
        if (!isEditMode) {
            const currentCount = currentDivisiCounts[selectedDivisi] || 0;
            const maxQuota = kuotaDivisi[selectedDivisi] || 0;
            if (currentCount >= maxQuota) {
                alert(`‚ùå Gagal menyimpan! Kuota untuk divisi ${selectedDivisi} (${maxQuota}) sudah penuh.`);
                return;
            }
        }

        // Konfirmasi jika Welpart/Kas di bawah minimum (BARU)
        if (parseInt(welpartInput.value) < minWelpart || parseInt(kasInput.value) < minKas) {
             if (!confirm('Kontribusi Welpart atau Kas belum mencapai minimum yang disarankan. Lanjutkan simpan data?')) {
                return; 
             }
        }

        const namaAnggota = document.getElementById('nama').value.trim();
        const tahunAngkatan = document.getElementById('angkatan').value.slice(-2);
        
        const dataAnggota = {
            nama: namaAnggota,
            divisi: selectedDivisi,
            jabatan: selectedDivisi === 'Bpi' ? document.getElementById('jabatanBPI').value : null,
            prodiAkt: `${document.getElementById('prodi').value.trim()}-${tahunAngkatan}`,
            welpart: parseInt(welpartInput.value) || 0,
            kas: parseInt(kasInput.value) || 0,
            hasilAkhir: parseInt(hasilAkhirInput.value) || 0, // Hasil Akhir Manual
        };

        const items = [];
        document.querySelectorAll('#item-list .item-group').forEach(group => {
            const harga = parseInt(group.querySelector('.harga-item').value) || 0;
            items.push({
                makanan: group.querySelector('.nama-makan').value.trim(),
                minuman: group.querySelector('.nama-minum').value.trim(),
                harga: harga
            });
        });

        const totalTagihan = items.reduce((sum, item) => sum + item.harga, 0);

        const dataPesanan = {
            pemesan: namaAnggota,
            items: items,
            tagihan_akhir_total: totalTagihan,
            status_pembayaran: document.getElementById('status').value,
            timestamp: new Date().toISOString() 
        };
        
        try {
            let anggotaKeyToUpdate = isEditMode ? editKeyAnggotaInput.value : null;

            const resAnggota = await saveOrUpdateToFirebase('anggota', anggotaKeyToUpdate, dataAnggota, 'Anggota');
            await saveOrUpdateToFirebase('pesanan', editKeyPesananInput.value, dataPesanan, 'Pesanan');

            if (!isEditMode) {
                anggotaKeyToUpdate = resAnggota; 
                alert(`Data berhasil disimpan!`);
            } else {
                alert(`Data ${namaAnggota} berhasil diperbarui!`);
            }

            resetIntegratedForm();
            loadFinalTable(true, anggotaKeyToUpdate); 

        } catch (error) {
            alert(error.message);
        }
    });
    
    // FUNGSI HAPUS TUNGGAL
    window.deleteData = function(anggotaKey, pesananKey, nama) {
        if (!confirm(`Yakin ingin menghapus data anggota ${nama} dan pesanannya?`)) return;
        if (!confirm('KONFIRMASI TERAKHIR. DATA AKAN TERHAPUS. Lanjutkan?')) return;

        // Ambil data sebelum dihapus untuk fitur 'Undo'
        const deletedAnggota = combinedData.find(d => d.anggotaKey === anggotaKey);
        if (deletedAnggota) {
            deletedItemsCache.push(deletedAnggota);
            undoDeleteBtn.style.display = 'inline-block';
        }
        
        try {
            database.ref(`anggota/${anggotaKey}`).remove();
            database.ref(`pesanan/${pesananKey}`).remove();
            alert(`‚úÖ Data ${nama} berhasil dihapus.`);
            // Pembaruan akan otomatis oleh listener
        } catch (error) {
            console.error('Delete Error:', error);
            alert('‚ùå Gagal menghapus data.');
        }
    }

    // FUNGSI EDIT DATA
    window.editData = function(anggotaKey, pesananKey) {
        const data = combinedData.find(d => d.anggotaKey === anggotaKey);
        if (!data) return alert('Data tidak ditemukan.');

        // 1. Data Anggota
        editKeyAnggotaInput.value = anggotaKey;
        document.getElementById('nama').value = data.nama;
        divisiSelect.value = data.divisi;
        document.getElementById('prodi').value = data.prodiAkt.split('-')[0];
        document.getElementById('angkatan').value = '20' + data.prodiAkt.split('-')[1];
        welpartInput.value = data.welpart;
        kasInput.value = data.kas;
        hasilAkhirInput.value = data.hasilAkhir;

        // Panggil untuk update tampilan kuota, status, dan jabatan
        updateDivisiFields(true, data.divisi);
        checkWelpart();
        checkKas();
        if (data.divisi === 'Bpi' && data.jabatan) {
            document.getElementById('jabatanBPI').value = data.jabatan;
        }

        // 2. Data Pesanan
        editKeyPesananInput.value = pesananKey;
        document.getElementById('status').value = data.status;

        const itemsContainer = document.getElementById('item-list');
        itemsContainer.innerHTML = '';
        itemCounter = 1;
        
        // Asumsi data.items ada di object combinedData (Perlu dipastikan saat load data)
        const pesananData = data.pesanan || []; // Gunakan data pesanan lengkap jika tersedia

        if (pesananData.length === 0 && data.pesananText) {
             // Jika data.pesanan tidak lengkap, setidaknya buat 1 item kosong agar form tidak error
             pesananData.push({ makanan: '', minuman: '', harga: 0 }); 
        }

        (pesananData.items || []).forEach((item) => {
             itemsContainer.innerHTML += createItemField(itemCounter++, item);
        });

        calculateTotal();

        submitBtn.textContent = `üíæ Perbarui Data ${data.nama}`;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // FUNGSI RENDER: Membangun Baris Tabel
    function createTableRow(data) {
        const row = document.createElement('tr');
        
        // Tentukan warna latar belakang untuk Welpart dan Kas (BARU)
        const welpartBgClass = data.welpart >= minWelpart ? 'cell-green-bg' : 'cell-red-bg';
        const kasBgClass = data.kas >= minKas ? 'cell-green-bg' : 'cell-red-bg';
        
        // Tentukan warna status pembayaran
        const statusClass = data.status === 'tidak' ? 'red-status-table' : '';
        const statusText = data.status === 'lunas' ? 'LUNAS' : 'TIDAK LUNAS';
        
        row.innerHTML = `
            <td><input type="checkbox" class="row-checkbox" data-anggota-key="${data.anggotaKey}" data-pesanan-key="${data.pesananKey}"></td>
            <td>${data.index}</td>
            <td>${data.nama}</td>
            <td>${data.divisi}${data.jabatan ? ` (${data.jabatan})` : ''}</td>
            <td>${data.prodiAkt}</td>
            <td class="item-list-cell">${data.pesananText}</td>
            <td>${formatter.format(data.tagihanTotal)}</td>
            <td class="${welpartBgClass}">${formatter.format(data.welpart)}</td>
            <td class="${kasBgClass}">${formatter.format(data.kas)}</td>
            <td>${formatter.format(data.hasilAkhir)}</td>
            <td class="${statusClass}">${statusText}</td>
            <td>
                <button class="edit-btn action-btn" onclick="editData('${data.anggotaKey}', '${data.pesananKey}')">‚úèÔ∏è Edit</button>
                <button class="delete-btn action-btn" onclick="deleteData('${data.anggotaKey}', '${data.pesananKey}', '${data.nama}')">üóëÔ∏è Hapus</button>
            </td>
        `;
        return row;
    }

    // FUNGSI UTAMA: Render/Gambar Ulang Tabel
    function renderFinalTable() {
        finalTableBody.innerHTML = '';
        let filteredData = combinedData;

        // Filter Divisi
        if (currentFilterDivisi) {
            filteredData = filteredData.filter(item => item.divisi === currentFilterDivisi);
        }

        // Filter Pencarian
        const searchVal = document.getElementById('searchInput').value.toLowerCase().trim();
        if (searchVal) {
             filteredData = filteredData.filter(item => 
                item.nama.toLowerCase().includes(searchVal) ||
                item.divisi.toLowerCase().includes(searchVal) ||
                item.prodiAkt.toLowerCase().includes(searchVal)
            );
        }
        
        if (filteredData.length === 0) {
            finalTableBody.innerHTML = `<tr><td colspan="12" style="text-align: center;">Tidak ada data yang tersedia atau tidak ditemukan.</td></tr>`;
            return;
        }

        filteredData.forEach((data, index) => {
            data.index = index + 1; 
            finalTableBody.appendChild(createTableRow(data));
        });
        
        updateSelectionState(); 
    }
    
    // FUNGSI INTI: Muat dan Gabungkan Data dari Firebase (Diperbarui untuk menyimpan detail pesanan)
    async function loadFinalTable(scrollToTop = false, highlightKey = null) {
        finalTableBody.innerHTML = '<tr><td colspan="12" style="text-align: center;">Memuat data gabungan...</td></tr>';
        
        try {
            const anggotaSnapshot = await database.ref('anggota').once('value');
            const pesananSnapshot = await database.ref('pesanan').once('value');
            
            const anggotaData = anggotaSnapshot.val() || {};
            const pesananData = pesananSnapshot.val() || {};
            
            combinedData = [];
            currentDivisiCounts = {}; 

            const pesananMap = {};
            for (const key in pesananData) {
                if (pesananData.hasOwnProperty(key)) {
                    pesananMap[pesananData[key].pemesan] = { ...pesananData[key], pesananKey: key };
                }
            }
            
            let index = 1;
            for (const anggotaKey in anggotaData) {
                if (anggotaData.hasOwnProperty(anggotaKey)) {
                    const anggota = anggotaData[anggotaKey];
                    const pesanan = pesananMap[anggota.nama]; 
                    
                    currentDivisiCounts[anggota.divisi] = (currentDivisiCounts[anggota.divisi] || 0) + 1;

                    if (pesanan) {
                        const pesananText = pesanan.items.map(item => `${item.makanan} + ${item.minuman} (${formatter.format(item.harga)})`).join('\n');
                        
                        combinedData.push({
                            index: index++,
                            anggotaKey: anggotaKey,
                            pesananKey: pesanan.pesananKey,
                            nama: anggota.nama,
                            divisi: anggota.divisi,
                            jabatan: anggota.jabatan,
                            prodiAkt: anggota.prodiAkt,
                            pesananText: pesananText,
                            tagihanTotal: pesanan.tagihan_akhir_total,
                            welpart: anggota.welpart,
                            kas: anggota.kas,
                            hasilAkhir: anggota.hasilAkhir,
                            status: pesanan.status_pembayaran,
                            pesanan: pesanan // Simpan objek pesanan lengkap untuk fungsi edit
                        });
                    }
                }
            }
            
            updateDivisiFields(false); 
            renderFinalTable(); 
            
            if (scrollToTop) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

        } catch (error) {
            console.error('Gagal memuat data:', error);
            finalTableBody.innerHTML = `<tr><td colspan="12" style="text-align: center; color: red;">‚ùå Gagal memuat data dari Firebase. Cek koneksi atau konfigurasi.</td></tr>`;
        }
    }
    
    // Mulai mendengarkan perubahan data di Firebase (Listener Realtime)
    database.ref('anggota').on('value', () => loadFinalTable());


    // --- 4. FUNGSI PELENGKAP (Item Pesanan, Total, Filter, Delete Massal) ---

    // Membangun Field Item Pesanan
    function createItemField(id, data = { makanan: '', minuman: '', harga: 0 }) {
        return `
            <div class="item-group" id="item_${id}">
                <h4>Item ${id} <button type="button" class="remove-item-btn" onclick="removeItem('${id}')">Hapus Item</button></h4>
                <div class="input-group-row">
                    <div class="form-group"><label>Makanan:</label><input type="text" class="nama-makan" value="${data.makanan}" required></div>
                    <div class="form-group"><label>Minuman:</label><input type="text" class="nama-minum" value="${data.minuman}" required></div>
                    <div class="form-group" style="flex: 0.5;"><label>Harga (Rp):</label><input type="number" class="harga-item" value="${data.harga}" required min="0" oninput="calculateTotal()"></div>
                </div>
            </div>
        `;
    }

    // Tambah Item Pesanan
    document.getElementById('addItemBtn').addEventListener('click', () => {
        itemCounter++;
        const itemsContainer = document.getElementById('item-list');
        itemsContainer.insertAdjacentHTML('beforeend', createItemField(itemCounter));
        calculateTotal();
    });

    // Hapus Item Pesanan
    window.removeItem = function(id) {
        if (document.querySelectorAll('#item-list .item-group').length > 1) {
            document.getElementById(`item_${id}`).remove();
            calculateTotal();
        } else {
            alert('Minimal harus ada 1 item pesanan.');
        }
    }

    // Hitung Total Pesanan
    window.calculateTotal = function() {
        let total = 0;
        document.querySelectorAll('.harga-item').forEach(input => {
            total += parseInt(input.value) || 0;
        });
        document.getElementById('tagihanAkhir').value = formatter.format(total);
    }
    
    // Pencarian Tabel
    window.searchTable = function() {
        renderFinalTable(); 
    }

    // Filter Tabel
    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            currentFilterDivisi = btn.getAttribute('data-divisi');
            filterButtons.forEach(b => b.style.backgroundColor = '#007bff');
            btn.style.backgroundColor = '#28a745';
            renderFinalTable();
        });
    });

    // Fitur Select All & Delete Selected
    selectAllCheckbox.addEventListener('change', (e) => {
        document.querySelectorAll('.row-checkbox').forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
        updateSelectionState();
    });

    document.getElementById('finalDataTable').addEventListener('change', (e) => {
        if (e.target.classList.contains('row-checkbox')) {
            updateSelectionState();
        }
    });

    function updateSelectionState() {
        const selected = document.querySelectorAll('.row-checkbox:checked');
        const total = document.querySelectorAll('.row-checkbox').length;
        selectedCountSpan.textContent = selected.length;
        deleteSelectedBtn.style.display = selected.length > 0 ? 'inline-block' : 'none';
        
        // Atur status "Select All"
        if (total > 0 && selected.length === total) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else if (selected.length > 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
    }

    deleteSelectedBtn.addEventListener('click', () => {
        const selected = document.querySelectorAll('.row-checkbox:checked');
        if (selected.length === 0) return;

        if (!confirm(`Yakin ingin menghapus ${selected.length} data yang dipilih?`)) return;
        if (!confirm('KONFIRMASI TERAKHIR. Data akan dihapus permanen. Lanjutkan?')) return;
        
        deletedItemsCache = []; // Reset cache
        const deletions = [];

        selected.forEach(checkbox => {
            const anggotaKey = checkbox.getAttribute('data-anggota-key');
            const pesananKey = checkbox.getAttribute('data-pesanan-key');

            const deletedAnggota = combinedData.find(d => d.anggotaKey === anggotaKey);
            if (deletedAnggota) deletedItemsCache.push(deletedAnggota);

            deletions.push(database.ref(`anggota/${anggotaKey}`).remove());
            deletions.push(database.ref(`pesanan/${pesananKey}`).remove());
        });

        Promise.all(deletions).then(() => {
            alert(`‚úÖ ${selected.length} data berhasil dihapus.`);
            undoDeleteBtn.style.display = 'inline-block';
            // Listener akan memuat ulang tabel secara otomatis
        }).catch(error => {
            console.error('Mass Delete Error:', error);
            alert('‚ùå Gagal menghapus sebagian atau seluruh data.');
        });
    });

    undoDeleteBtn.addEventListener('click', async () => {
        if (deletedItemsCache.length === 0) return;

        if (!confirm(`Yakin ingin mengembalikan ${deletedItemsCache.length} data yang baru saja dihapus?`)) return;

        const restorations = [];
        deletedItemsCache.forEach(data => {
            // Restore Anggota
            const dataAnggota = {
                nama: data.nama, divisi: data.divisi, jabatan: data.jabatan,
                prodiAkt: data.prodiAkt, welpart: data.welpart, kas: data.kas,
                hasilAkhir: data.hasilAkhir
            };
            restorations.push(database.ref(`anggota/${data.anggotaKey}`).set(dataAnggota));

            // Restore Pesanan
            const dataPesanan = {
                pemesan: data.nama, items: data.pesanan.items,
                tagihan_akhir_total: data.tagihanTotal,
                status_pembayaran: data.status, timestamp: new Date().toISOString()
            };
            restorations.push(database.ref(`pesanan/${data.pesananKey}`).set(dataPesanan));
        });

        Promise.all(restorations).then(() => {
            alert(`‚úÖ ${deletedItemsCache.length} data berhasil dikembalikan.`);
            deletedItemsCache = [];
            undoDeleteBtn.style.display = 'none';
        }).catch(error => {
            console.error('Undo Error:', error);
            alert('‚ùå Gagal mengembalikan sebagian atau seluruh data.');
        });
    });

</script>
</body>
</html>
