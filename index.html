<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Keuangan CWU</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
  body.modal-open { overflow: hidden; }
  body { font-family: 'Inter', sans-serif; }
  @media (max-width: 768px){
    header h1 { font-size: 1.3rem; }
    header p { font-size: 0.8rem; }
    .grid { grid-template-columns: 1fr !important; }
    table th, table td { font-size: 0.8rem; padding: 6px !important; }
    .w-96 { width: 90% !important; }
  }
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-200 min-h-screen">

<!-- HEADER -->
<header class="bg-blue-700 text-white py-4 shadow-lg text-center sticky top-0 z-10">
  <h1 class="text-2xl font-bold tracking-wide">üíº Admin Keuangan CWU</h1>
  <p class="text-sm text-blue-100">Input dan Kelola Data Pembayaran</p>
</header>

<!-- MAIN CONTAINER -->
<div class="max-w-6xl mx-auto p-4 sm:p-6 grid lg:grid-cols-2 gap-6 mt-6">

  <!-- FORM INPUT -->
  <div class="bg-white rounded-2xl p-6 shadow-lg transition-all duration-300 hover:shadow-xl">
    <h2 class="text-xl font-semibold text-blue-700 mb-4 border-b pb-2 flex items-center gap-2">üìù Form Input</h2>
    <form id="formData" class="space-y-3">
      <input id="nama" type="text" placeholder="Nama Lengkap" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none" required>
      <select id="divisi" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none" required>
        <option value="">Pilih Divisi</option>
        <option value="Ketua Umum">Ketua Umum (1)</option>
        <option value="Wakil Ketua Umum">Wakil Ketua Umum (1)</option>
        <option value="Bendahara Umum">Bendahara Umum (2)</option>
        <option value="Sekretaris Umum">Sekretaris Umum (2)</option>
        <option value="Medinfo">Medinfo (10)</option>
        <option value="Networking">Networking (14)</option>
        <option value="Kewirausahaan">Kewirausahaan (12)</option>
        <option value="Inbis">Inbis (12)</option>
        <option value="Demis">Demis (10)</option>
      </select>
      <input id="prodi" type="text" placeholder="Prodi" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none" required>
      <select id="angkatan" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none" required>
        <option value="">Pilih Angkatan</option>
        <option value="21">2021</option>
        <option value="22">2022</option>
        <option value="23">2023</option>
        <option value="24">2024</option>
        <option value="25">2025</option>
      </select>
      <input id="nominal" type="number" placeholder="Nominal (Rp)" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none" required>
      <div class="space-y-2">
        <label class="flex items-center"><input type="radio" name="tipe" value="partisipasi_makan" class="mr-2"> Partisipasi + Makan</label>
        <label class="flex items-center"><input type="radio" name="tipe" value="full" class="mr-2"> Full (Partisipasi + Makan + Kas)</label>
      </div>
      <select id="status" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none">
        <option value="Belum Lunas">Belum Lunas</option>
        <option value="Lunas">Lunas</option>
      </select>
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-300 transform hover:scale-[1.02]">üíæ Simpan Data</button>
    </form>
    <p id="info" class="text-center mt-3 text-green-600 hidden">Data berhasil disimpan!</p>
  </div>

  <!-- TABEL DATA -->
  <div class="bg-white rounded-2xl p-6 shadow-lg overflow-x-auto transition-all duration-300 hover:shadow-xl">
    <h2 class="text-xl font-semibold text-blue-700 mb-4 border-b pb-2 flex items-center gap-2">üìã Data Pembayaran</h2>
    <div class="overflow-x-auto">
      <table class="w-full text-sm border min-w-[600px]">
        <thead class="bg-blue-100 text-blue-800">
          <tr>
            <th class="p-2 text-left">Nama</th>
            <th class="p-2 text-left">Divisi</th>
            <th class="p-2 text-left">Prodi - Akt</th>
            <th class="p-2 text-center">Nominal</th>
            <th class="p-2 text-center">Tipe</th>
            <th class="p-2 text-center">Status</th>
            <th class="p-2 text-center">Aksi</th>
          </tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- POPUP EDIT -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full sm:w-96 relative">
    <h2 class="text-xl font-semibold text-blue-700 mb-4 border-b pb-2">‚úèÔ∏è Edit Data</h2>
    <form id="editForm" class="space-y-3">
      <input id="editNama" type="text" class="w-full p-2 border rounded-lg" required>
      <input id="editProdi" type="text" class="w-full p-2 border rounded-lg" required>
      <select id="editAngkatan" class="w-full p-2 border rounded-lg" required>
        <option value="">Pilih Angkatan</option>
        <option value="21">2021</option>
        <option value="22">2022</option>
        <option value="23">2023</option>
        <option value="24">2024</option>
        <option value="25">2025</option>
      </select>
      <select id="editDivisi" class="w-full p-2 border rounded-lg" required></select>
      <input id="editNominal" type="number" class="w-full p-2 border rounded-lg" required>
      <div class="space-y-2">
        <label class="flex items-center"><input type="radio" name="editTipe" value="partisipasi_makan" class="mr-2"> Partisipasi + Makan</label>
        <label class="flex items-center"><input type="radio" name="editTipe" value="full" class="mr-2"> Full (Partisipasi + Makan + Kas)</label>
      </div>
      <select id="editStatus" class="w-full p-2 border rounded-lg">
        <option value="Belum Lunas">Belum Lunas</option>
        <option value="Lunas">Lunas</option>
      </select>
      <div class="flex justify-between pt-3">
        <button type="button" onclick="closeModal()" class="bg-gray-400 text-white px-3 py-1 rounded-lg hover:bg-gray-500">Batal</button>
        <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700">Simpan</button>
      </div>
    </form>
  </div>
</div>

<footer class="text-center text-sm text-blue-600 mt-8 mb-4">¬© 2025 CWU Gen 2 | Admin Panel</footer>

<script>
// Firebase Init
const firebaseConfig = { apiKey: "AIzaSyDpPEkKbEt6b_v2OWlBfGuaVQpBg2-RWR4", authDomain: "cwu-gen-2.firebaseapp.com", databaseURL: "https://cwu-gen-2-default-rtdb.firebaseio.com", projectId: "cwu-gen-2", storageBucket: "cwu-gen-2.appspot.com", messagingSenderId: "40585612014", appId: "1:40585612014:web:c88141fee369aca68181ff" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const form = document.getElementById("formData");
const table = document.getElementById("dataTable");
const info = document.getElementById("info");
const divisiSelect = document.getElementById("divisi");

const kuota = { "Ketua Umum":1,"Wakil Ketua Umum":1,"Bendahara Umum":2,"Sekretaris Umum":2,"Medinfo":10,"Networking":14,"Kewirausahaan":12,"Inbis":12,"Demis":10 };

// Update kuota dan disable divisi penuh
function updateKuota(){
  db.ref("keuangan").once("value", snap=>{
    const data = snap.val()||{};
    const count = {};
    Object.values(data).forEach(d=>{
      if(kuota[d.divisi]) count[d.divisi]=(count[d.divisi]||0)+1;
    });
    [...divisiSelect.options].forEach(opt=>{
      if(kuota[opt.value]){
        const used = count[opt.value]||0;
        opt.disabled = used>=kuota[opt.value];
        opt.textContent = used>=kuota[opt.value]?`${opt.value} (Penuh)`: `${opt.value} (${kuota[opt.value]-used} slot tersisa)`;
      }
    });
  });
}
updateKuota();

// Submit Form
form.addEventListener("submit", e=>{
  e.preventDefault();
  const nama=document.getElementById("nama").value.trim();
  const divisi=divisiSelect.value;
  const prodi=document.getElementById("prodi").value.trim();
  const angkatan=document.getElementById("angkatan").value.trim();
  const nominal=parseInt(document.getElementById("nominal").value)||0;
  const tipe=document.querySelector("input[name='tipe']:checked")?.value;
  const status=document.getElementById("status").value;
  if(!tipe||!divisi||!angkatan) return alert("Lengkapi semua field!");
  db.ref("keuangan").push({ nama, divisi, prodi, angkatan, nominal, tipe, status });
  form.reset(); showInfo("Data berhasil disimpan!");
  updateKuota();
});

// Show info
function showInfo(txt){
  info.textContent=txt;
  info.classList.remove("hidden");
  setTimeout(()=>info.classList.add("hidden"),2000);
}

// Render Table
db.ref("keuangan").on("value", snap=>{
  const data=snap.val()||{};
  table.innerHTML="";
  Object.entries(data).forEach(([id,d])=>{
    const row=document.createElement("tr");
    row.className="border-b hover:bg-blue-50 transition-colors duration-200";
    row.innerHTML=`
      <td class='p-2'>${d.nama}</td>
      <td class='p-2'>${d.divisi}</td>
      <td class='p-2'>${d.prodi}-${d.angkatan}</td>
      <td class='p-2 text-center'>Rp ${d.nominal.toLocaleString()}</td>
      <td class='p-2 text-center'>${d.tipe.replace("_","+")}</td>
      <td class='p-2 text-center font-semibold'>
        <span class='px-2 py-1 rounded text-xs ${d.status==="Lunas"?"bg-green-200 text-green-800":"bg-red-200 text-red-800"}'>${d.status}</span>
      </td>
      <td class='p-2 text-center space-x-1'>
        <button class='bg-yellow-400 hover:bg-yellow-500 text-white px-2 py-1 rounded text-xs' onclick="openEdit('${id}')">Edit</button>
        <button class='bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs' onclick="confirmDelete('${id}')">Hapus</button>
      </td>`;
    table.appendChild(row);
  });
  updateKuota();
});

// Konfirmasi hapus
function confirmDelete(id){
  if(confirm("‚ö†Ô∏è Yakin ingin menghapus data ini?")){
    firebase.database().ref('keuangan/'+id).remove();
    showInfo("Data berhasil dihapus!");
    updateKuota();
  }
}

// Modal edit
let editID=null;
function openEdit(id){
  editID=id;
  document.body.classList.add("modal-open");
  const modal=document.getElementById("editModal");
  modal.classList.remove("hidden");
  db.ref("keuangan/"+id).once("value", snap=>{
    const d=snap.val();
    editNama.value=d.nama;
    editProdi.value=d.prodi;
    editAngkatan.value=d.angkatan;
    editNominal.value=d.nominal;
    editStatus.value=d.status;
    editDivisi.innerHTML=divisiSelect.innerHTML;
    editDivisi.value=d.divisi;
    document.querySelector(`input[name='editTipe'][value='${d.tipe}']`).checked=true;
  });
}

function closeModal(){
  document.body.classList.remove("modal-open");
  document.getElementById("editModal").classList.add("hidden");
}

document.getElementById("editForm").addEventListener("submit", e=>{
  e.preventDefault();
  const data={
    nama:editNama.value.trim(),
    prodi:editProdi.value.trim(),
    angkatan:editAngkatan.value,
    divisi:editDivisi.value,
    nominal:parseInt(editNominal.value)||0,
    tipe:document.querySelector("input[name='editTipe']:checked")?.value,
    status:editStatus.value
  };
  db.ref("keuangan/"+editID).update(data);
  closeModal();
  showInfo("Data berhasil diperbarui!");
  updateKuota();
});
</script>
</body>
</html>
